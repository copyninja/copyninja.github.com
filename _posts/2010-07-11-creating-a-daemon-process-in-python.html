--- 
layout: post
title: "Creating a Daemon Process in Python"
published: true
meta: 
  blogger_author: Vasudev Kamathhttp://www.blogger.com/profile/05106578827322209004noreply@blogger.com
  blogger_blog: blog.copyninja.info
  blogger_permalink: /2010/07/creating-daemon-process-in-python.html
tags: 
- daemon process
- Programming
- python
type: post
status: publish
---
<div xmlns="http://www.w3.org/1999/xhtml">Daemons in computer world refers to a process that runs in background in a Unix like operating system you can read more on Daemons in this <a href="http://en.wikipedia.org/wiki/Daemon_%28computer_software%29" target="_blank" title="Daemon Process">Wikipedia article</a>. I knew how to create a daemon in the C program but didn't find any good article on how to do it in Python except this <a href="http://code.activestate.com/recipes/278731-creating-a-daemon-the-python-way/" target="_blank" title="Python Daemon">one</a>. The main guidelines for writing a daemon process are as follows<br /><ol><li>First the program needs to fork and parent should exit leaving the child as orphan which will be then adopted by the <b><i>init </i></b>process which is parent of all process in Unix like operating system. Caution: do take care so that your process doesn't end up as a Zombie Process (avoided by doing a double fork. 1st parent forks a child which then forks a second child after forking first child exits and then parent exits and the second child continues to execute as a daemon)<a name='more'></a></li><li>A process has a controlling terminal and receives all signal from the terminal. Child inherits the terminal of process but a daemon should not receive any signal from controlling terminal so we need to disassociate from any terminal and also from process groups. This can be done by creating its own process group and becoming the session leader. To achieve this <b><i>setsid</i></b> system call is used</li><li>By default a child process also inherits open file descriptor from its parent and most of the time it may not be using these resources so its good if we release/close all these file descriptors.</li><li>Next is setting the working directory as / (root) this is done so that process doesn't keep any directory in use on a mounted file system (not allowing to unmount). But using / may not be good in all cases so working directory should be chosen carefully. This can be achived using <b><i>chdir</i></b> system call</li><li>Setting the file creation mask is next step. Normally daemons will be running as super user and files created by it needs to be protected. This can be done by using <b><i>umask</i></b> system call.</li><li>Catching the Signals is the next step. Normally daemon process may get signal from a user or other process. For eg a child process may send SIGCHLD when it terminates. Daemons should catch these signals and act accordingly (except SIGKILL). This can be done using signal handlers utilizing signal.h</li><li>Daemon process won't be attached to any terminals or consoles so messages from daemon process needs to be written to some file or we need to use syslogd interface to log the events which is more flexible.</li></ol>Well that’s about the steps / guide lines to create a daemon processes. Here is the code which I wrote in Python which uses double forking and creates a simple daemon which actually does nothing :P.<br /><script src="http://gist.github.com/596645.js">As you can see this program follows all the 7 steps. I used the double forking method to avoid Zombies. First child becomes session leader using os.setsid and forks second child then it exits. Second child changes the working directory to /tmp and sets umask, at this point parent process is done. Next it tries to close all file descriptor which may have been inherited from parent. I simply go from 0 to max allowed files by the system and try to close each of them. If closing fails it doesn't matter try next one ;). Finally I have a signal handler which handles hangup and terminate signals, child stop etc are ignored. Then in the main part simply loop for ever sleeping for 1 second :D. That’s it your daemon is ready to run. Here is the orignal <a href="http://www.enderunix.org/docs/eng/daemon.php" target="_blank" title="Daemon process in C">C program</a> To check if your program is running just use following command.<blockquote><i>ps -eF | grep test_daemon.py</i></blockquote>Replace with file name you gave. Here is the sample output<blockquote><i>root     18754     1  0  2533  2308   0 21:31 ?        00:00:00 /usr/bin/python ./test_daemon.py</i></blockquote>1 in the third column indicates that this process's parent is init. Try following commands <blockquote><i>kill -HUP 18574</i></blockquote><blockquote><i>kill 18574</i></blockquote>Now if you see the log file in /tmp/pydaemond.log you will see signal handler has caught the signals and logged it. PID can be found in the /tmp/pydaemond.lock file. Change the file name and directory to suit your needs. Thats all for now C ya.Vasudev</div></script></div>
