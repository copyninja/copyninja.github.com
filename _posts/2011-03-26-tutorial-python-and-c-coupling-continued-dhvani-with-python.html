--- 
layout: post
title: ">Tutorial: Python and C Coupling Continued (Dhvani with Python)"
published: true
meta: 
  blogger_author: Vasudev Kamathhttp://www.blogger.com/profile/05106578827322209004noreply@blogger.com
  blogger_blog: blog.copyninja.info
  blogger_permalink: /2011/03/tutorial-python-and-c-coupling.html
tags: 
- C
- Programming
- python
type: post
status: publish
---
><div dir="ltr" style="text-align: left;" trbidi="on"><div style="text-align: justify;">In my previous <a href="http://vasudevkamath.blogspot.com/2010/07/python-and-c-coupling.html">post</a> I gave a brief tutorial on how to use C shared library in Python using ctypes module. The example for the tutorial was very simple and didn't involve any complex data structures. In this post I'll be giving a brief insight on how to use <i>ctypes</i> to interact with C libraries involving complex data structures and function pointer. In this example I'll be using <a href="http://dhvani.sourceforge.net/">Dhvani</a> an Indian Language TTS system. Here is the <a href="http://dhvani.sourceforge.net/doc/apis.html">Dhvani API reference. </a></div><br /><blockquote>&nbsp;&nbsp;&nbsp; <i><b>Problem:</b></i> Use dhvani API's to genreate speech or a output file in Python</blockquote><br /><a name='more'></a><br /><br /><div style="text-align: justify;">Let's have a look at the Dhvani API reference (link given above). We have a structure&nbsp; <i><b>dhvani_options</b></i> which is very important part of dhvani API. Below is the structure</div><br /><blockquote>&nbsp;<i><span style="font-size: x-small;"><span style="font-family: Arial,Helvetica,sans-serif;">&nbsp;&nbsp; typedef struct {</span></span></i><br /><i><span style="font-size: x-small;"><span style="font-family: Arial,Helvetica,sans-serif;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; struct dhvani_VOICE *voice; /* not used now.. for future use.*/</span></span></i><br /><i><span style="font-size: x-small;"><span style="font-family: Arial,Helvetica,sans-serif;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; float pitch;</span></span></i><br /><i><span style="font-size: x-small;"><span style="font-family: Arial,Helvetica,sans-serif;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; float tempo;</span></span></i><br /><i><span style="font-size: x-small;"><span style="font-family: Arial,Helvetica,sans-serif;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int rate;</span></span></i><br /><i><span style="font-size: x-small;"><span style="font-family: Arial,Helvetica,sans-serif;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dhvani_Languages language;</span></span></i><br /><i><span style="font-size: x-small;"><span style="font-family: Arial,Helvetica,sans-serif;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int output_file_format;</span></span></i><br /><i><span style="font-size: x-small;"><span style="font-family: Arial,Helvetica,sans-serif;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int isPhonetic;</span></span></i><br /><i><span style="font-size: x-small;"><span style="font-family: Arial,Helvetica,sans-serif;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int speech_to_file;</span></span></i><br /><i><span style="font-size: x-small;"><span style="font-family: Arial,Helvetica,sans-serif;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; char* output_file_name;</span></span></i><br /><i><span style="font-size: x-small;"><span style="font-family: Arial,Helvetica,sans-serif;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; t_dhvani_synth_callback* synth_callback_fn;</span></span></i><br /><i><span style="font-size: x-small;"><span style="font-family: Arial,Helvetica,sans-serif;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; t_dhvani_audio_callback* audio_callback_fn;</span></span></i><br /><i><span style="font-size: x-small;"><span style="font-family: Arial,Helvetica,sans-serif;">&nbsp;&nbsp;&nbsp; } dhvani_options;</span></span></i></blockquote><br />&nbsp;And an enum <i>dhvani_ERROR </i><br /><br /><blockquote>&nbsp;<i><span style="font-family: Arial,Helvetica,sans-serif; font-size: x-small;">&nbsp;&nbsp; typedef enum {</span></i><br /><i><span style="font-family: Arial,Helvetica,sans-serif; font-size: x-small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DHVANI_OK = 0,</span></i><br /><i><span style="font-family: Arial,Helvetica,sans-serif; font-size: x-small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DHVANI_INTERNAL_ERROR = -1</span></i><br /><i><span style="font-family: Arial,Helvetica,sans-serif; font-size: x-small;">&nbsp;&nbsp;&nbsp; } dhvani_ERROR;</span></i></blockquote><br /><div style="text-align: justify;">Now if we carefully observe the dhvani_options structure it involves a few complex data structure like <i>dhvani_VOICE</i> (structure) <i>t_dhvani_synth_callback</i> and <i>t_dhvani_audio_callback</i> and an enum <i>dhvani_Languages</i>. Besides this all others are basic data structures. I had to hack the dhvani source code to see what are this complex data structures are and below is the snippets which I found in dhvani source code.</div><br /><blockquote><i><span style="font-family: Arial,Helvetica,sans-serif; font-size: x-small;">&nbsp;&nbsp;&nbsp; typedef enum {</span></i><br /><i><span style="font-family: Arial,Helvetica,sans-serif; font-size: x-small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; HINDI = 1,</span></i><br /><i><span style="font-family: Arial,Helvetica,sans-serif; font-size: x-small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MALAYALAM = 2,</span></i><br /><i><span style="font-family: Arial,Helvetica,sans-serif; font-size: x-small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; TAMIL = 3,</span></i><br /><i><span style="font-family: Arial,Helvetica,sans-serif; font-size: x-small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; KANNADA = 4,</span></i><br /><i><span style="font-family: Arial,Helvetica,sans-serif; font-size: x-small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ORIYA = 5,</span></i><br /><i><span style="font-family: Arial,Helvetica,sans-serif; font-size: x-small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PANJABI = 6,</span></i><br /><i><span style="font-family: Arial,Helvetica,sans-serif; font-size: x-small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; GUJARATI = 7,</span></i><br /><i><span style="font-family: Arial,Helvetica,sans-serif; font-size: x-small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; TELUGU = 8,</span></i><br /><i><span style="font-family: Arial,Helvetica,sans-serif; font-size: x-small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BENGALI = 9,</span></i><br /><i><span style="font-family: Arial,Helvetica,sans-serif; font-size: x-small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MARATHI = 10,</span></i><br /><i><span style="font-family: Arial,Helvetica,sans-serif; font-size: x-small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PASHTO = 11</span></i><br /><i><span style="font-family: Arial,Helvetica,sans-serif; font-size: x-small;">&nbsp;&nbsp;&nbsp; } dhvani_Languages;</span></i><br /><br /><i><span style="font-family: Arial,Helvetica,sans-serif; font-size: x-small;">&nbsp;&nbsp;&nbsp; typedef int (t_dhvani_synth_callback) (int);</span></i><br /><i><span style="font-family: Arial,Helvetica,sans-serif; font-size: x-small;">&nbsp;&nbsp;&nbsp; typedef int (t_dhvani_audio_callback) (short *, int); </span></i></blockquote><br /><i>&nbsp;dhvani_VOICE</i> structure was never defined it was meant only for future use, so it spared me some time :). I also found one more enum in the source which are used by the API's. I'm listing them below.<br /><br /><blockquote>&nbsp;<i style="font-family: Arial,Helvetica,sans-serif;"><span style="font-size: x-small;">&nbsp;&nbsp; typedef enum {</span></i><br /><i style="font-family: Arial,Helvetica,sans-serif;"><span style="font-size: x-small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DHVANI_OGG_FORMAT = 0,</span></i><br /><i style="font-family: Arial,Helvetica,sans-serif;"><span style="font-size: x-small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DHVANI_WAV_FORMAT</span></i><br /><i style="font-family: Arial,Helvetica,sans-serif;"><span style="font-size: x-small;">&nbsp;&nbsp;&nbsp; } dhvani_output_file_format;</span></i></blockquote><br /><div style="text-align: justify;">So we need to define few enums and a dummy strucute and 2 function pointers in Python before we can define <i>dhvani_options</i> structure in Python. Look at the below snippet</div><script src="https://gist.github.com/888072.js"></script><br /><br /><div style="text-align: justify;">Since there is nothing equivalent to enums in Python we just define constants with int value to match enumeration in C. We are using <i>CFUNCTYPE</i> from <i>ctypes</i> library to define the callback function which are nothing but function pointers in <i>CFUNCTYPE</i> allows us to specify the <i>return type</i> of the functions and the <i>arguments</i> to the function. Next is <i>dhvani_VOICE</i> structure as you can see its just a place holder.</div><div style="text-align: justify;">So now we have defined all the required data structures its time we define the main structure of dhvani i.e <i>dhvani_options. </i>Below is the snippet of code for defining <i>dhvani_options</i> in Python.</div><script src="https://gist.github.com/888111.js"> </script><br /><br /><div style="text-align: justify;">To define a structure we need to create a class that inherits from <i>ctypes.Structure</i> clas. All the fields of the strucutre are defined as the list of tupples <i>__fields__</i>. Each tuple contains a string specifying name of the field in C structure and its type. The new type you can see here is <i>POINTER</i> which is a ctype function for C Pointer type. Rest of the code is self explanatory.</div><br />With this we have all the required data structures defined in Python. Next step is to find the required functions and map them to Python equivalent function calls. Inspecting the dhvani API reference we&nbsp; see that function calls <i>dhvani_say</i> and <i>dhvani_speak_file</i> are required to generate audio from the text. Below is the prototype of these functions.<br /><blockquote><div style="font-family: Arial,Helvetica,sans-serif;"><span style="font-size: x-small;"><i>dhvani_ERROR dhvani_say(char *, dhvani_options *);</i></span></div><span style="font-family: Arial,Helvetica,sans-serif; font-size: x-small;"><i> dhvani_ERROR dhvani_speak_file(FILE *, dhvani_options *);</i></span></blockquote><div style="text-align: justify;"><i>&nbsp;dhvani_say</i> is a simple function but <i>dhvani_speak_file</i> expects <i>FILE</i>* as first argument!! Now that is problematic, we don't have anything equivalaent to C's <i>FILE*</i> structure. After searching for a while finally I found this <a href="http://stackoverflow.com/questions/3794309/python-ctypes-python-file-object-c-file">answer</a>. The trick is use Python's <i>file</i> object to open the file and use <i>fileno() </i>API of <i>file</i> object to get back the integer file descriptor, then use <i>fdopen</i> function call provided by standard C library to get back <i>FILE*</i> structure for the descriptor. Since dhvani uses standard C library shared library of dhvani will contain reference to <i>fdopen</i> so next step is to map <u><i>fdopen</i></u> to Python function call. Below is prototype of <i>fdopen</i> which I'll be using.</div><blockquote><i><span style="font-family: Arial,Helvetica,sans-serif; font-size: x-small;">FILE *fdopen(int fd, const char *mode);</span></i></blockquote>&nbsp;And below is the snippet for mapping all these 3 functions to Python<br /><br /><script src="https://gist.github.com/888127.js"> </script><br /><br /><div style="text-align: justify;">As you can see wherever <i>FILE*</i> was used in C functions I used <i>c_void_p</i> i.e void pointer, this is mainly because pointers all have same memory size the type only indicates what type of content is present in the memory location pointed by the pointers. So in this case I'm telling python run-time that its void pointer but during the call where prototype expects (FILE*) it will be automatically typecasted (at least I assume so if you have better explanation please comment)</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">So we have everything read now and we can directly use dhvani API's to get the audio generated for any Indian Language from our python code. Below is the code of tts module of <a href="http://silpa.org.in/">SILPA</a> which now uses dhvani shared library and is out of its experimental status.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;"><script src="https://gist.github.com/888132.js"> </script><br /><br />I won't be explaining rest of the code here as its self explanatory and my job was to explain the important part i.e coupling dhvani library with Python. And that is done :). Please give the suggestions in comments :)<br /><br /><b style="color: red;"><i>P.S: The entire code may not be directly usable as it has code required to integrate it with SILPA</i></b><br /><br />-- Vasudev</div></div>
