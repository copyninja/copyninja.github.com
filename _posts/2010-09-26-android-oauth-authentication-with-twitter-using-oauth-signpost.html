--- 
layout: post
title: "Android: OAuth authentication with twitter using oauth-signpost"
published: true
meta: 
  blogger_author: Vasudev Kamathhttp://www.blogger.com/profile/05106578827322209004noreply@blogger.com
  blogger_blog: blog.copyninja.info
  blogger_permalink: /2010/09/android-oauth-authentication-with.html
tags: 
- Android
- OAuth
- Programming
- Twitter
type: post
status: publish
---
>Twitter has recently stopped support for Basic Authentication scheme in twitter API, from now on all the app which will be using twitter api's should use OAuth authentication system. To know what is OAuth refer this <a href="http://en.wikipedia.org/wiki/OAuth">wiki article</a> and OAuth official <a href="http://oauth.net/">website</a>.<br />It took me few days to completely understand what is actualy going behind the scene in OAuth authentication scheme, thanks to this wonderful <a href="http://www.jaanuskase.com/en/2010/01/understanding_the_guts_of_twit.html">article.</a><br />Before starting with tutorial I assume that you know basics of android like creating a project , editing manifest files and configuring build paths. I won't be covering those here. <br /><ol><li>For using OAuth in android we will use a library called oauth-signpost written in java and freely available <a href="http://code.google.com/p/oauth-signpost/">here</a>. Download the <a href="http://code.google.com/p/oauth-signpost/downloads/detail?name=signpost-core-1.2.1.1.jar&amp;can=2&amp;q=">oauth-signpost</a> core and<a href="http://code.google.com/p/oauth-signpost/downloads/detail?name=signpost-commonshttp4-1.2.1.1.jar&amp;can=2&amp;q="> commons http jars</a>. Add these jar's to the <i><b>assets</b></i> folder of your android project and add them to your project build path.</li><li>Before we begin we need to create a application in twitter and get our consumer key and consumer secret. Please go to this <a href="http://twitter.com/oauth_clients/new">page</a> and register your application</li><ul><li>Application Name: is the unique name for your application which appears in your twitter status message.</li><li>Application Type: Select <i><b>browser.</b></i></li><li>Callback URI: You can give any URL as of now, we are going to provide actual call back URL from our application code.</li><li>Once you are done with creating application copy the <i>consumer key</i> and <i>consumer secret</i> to a safe place </li></ul><li>Twitter uses call back URL to send back the verification PIN to our application. Normally browser type is used only for web application but what we are going to do is make our android application <i>browsable</i> and use Android's data URI schemes to get back PIN from twitter. Other approach is making&nbsp; application type as <i>client</i>. In this case verification number is displayed in browser and you should ask your user to manually enter the verfication number in specified text box.</li><li>To make the application browsable and register data URI schemes with android runtime add following intent filter to your activity in AndroidManifest.xml. Browsable means your application can be launched using the data URI scheme registered in android manifest. For eg. you can open the android browser and type in <i>scheme://host</i> and it will launch your application also you can pass data to application from URI line. </li><script src="http://gist.github.com/597990.js?file=gistfile1.xml"></script><li>&nbsp;Now declare the following variables, change consumer key and secret to the value you copied in step 2. Note that I'm declaring the <i>CommonsHttpOAuthConsumer</i> , <i>OAuthProvider</i> and <i>HttpClient </i>as static. I'll explain the reason later.</li><script src="http://gist.github.com/598071.js?file=vardefs.java"></script><li>Now add a button to your view (main.xml) and in your activities <i><b>onCreate</b></i> function add the following code.</li><script src="http://gist.github.com/598075.js?file=oauth_oncreate.java"></script><li>&nbsp;What actually we are doing here is retriving the unauthorized token and token secret from the Twitter and providing the twitter actual callback URL. When user authroizes the token and token secrets the verification code is sent to this URL (i.e browser will be redirected to this URL by twitter). Lets see what is really happening in the backend. Twitter redirects the browser to the call back url with oauth_token and oauth_verifier as query parameter. For eg. In our case to this URL <i>scheme://host?oauth_token=1xx&amp;oauth_verifer=1234</i>. Since we are using android data uri scheme as callback URL browser simply relaunches our application passing it the oauth_token and oauth_verifier as intent data.</li><li>Since android supports multitasking relaunching just brings our application to foreground and control comes to the <i><b>onResume </b></i>function. We need to add the following code to our onResume function</li><script src="http://gist.github.com/598086.js?file=oauth_onresume.java"></script><li>Now I'll tell you why I declared 3 variables as <b>static. </b>As you see when user clicks the button we are launching the browser with authorize url making our activity to go to background. And when browser returns if I didn't declare my consumer object as static i'll get error while trying to retrive the authorized token and token secret with exception message "<i>Authorized token and token secret not set did you already retrived the authorized token and token secret</i>". After a while of googling I got this <a href="http://efreedom.com/Question/1-3255153/Android-OAuth-Exception-RetrieveAccessToken">solution</a>. Looks like these fields in consumer object were getting reset, I think may be because of GC. Any way instead of reinitializing and going through all the pain once again I thought of declaring these variables as static and it worked like a charm!</li><li>Save the access token and access secret obtained in step 8 in a safe place. These should used in your further interaction with twitter without making user login to twitter again. Note that twitter doesn't expire these access token and secret. It will be expired only when user revokes the application permission.</li></ol>In the above example you might have noticed that I never used the http client which is declared. Wondering why? Well its used for posting status or retriving timelines from the twitter. You can ignore that variable :).<br />Thanks to this <a href="http://dev.bostone.us/2009/07/16/android-oauth-twitter-updates/">tutorial</a> which helped me in writing the above code. It looks like the version of oauth-signpost library used in this post is older than the one which I used. In the next part I'll show how to fetch the time line from twitter and also post the status update to twitter. Till then C ya :).
