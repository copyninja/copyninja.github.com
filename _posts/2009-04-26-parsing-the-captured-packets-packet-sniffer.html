--- 
layout: post
title: ">Parsing the Captured Packets : Packet Sniffer"
published: true
meta: 
  blogger_author: Vasudev Kamathhttp://www.blogger.com/profile/05106578827322209004noreply@blogger.com
  blogger_blog: blog.copyninja.info
  blogger_permalink: /2009/04/parsing-captured-packets-packet-sniffer.html
tags: 
- packet sniffer
- parsing ehternet header
type: post
status: publish
---
><div style="-webkit-background-clip: initial; -webkit-background-origin: initial; background-attachment: initial; background-color: white; background-image: initial; background-position: initial initial; background-repeat: initial; color: black; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 10px; font: normal normal normal 13px/19px Georgia, 'Times New Roman', 'Bitstream Charter', Times, serif; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px; padding-bottom: 0.6em; padding-left: 0.6em; padding-right: 0.6em; padding-top: 0.6em;"><div style="text-align: justify;">In my&nbsp;<a href="http://vasudevkamath.techfiz.com/2009/03/30/packet-sniffer%E2%80%A6g-pcap-utility/" mce_href="http://vasudevkamath.techfiz.com/2009/03/30/packet-snifferâ€¦g-pcap-utility/" target="_blank">previous post</a>&nbsp;I had mentioned about how to use pcap utilities for capturing packets. Now in this post I'm going to tell about how to parse the packet and get information from it. Before I explain the code there are few basic data structure that you need to know.<br /><code>struct ether_header</code></div><div style="text-align: justify;">This structure is located in&nbsp;<span id="" mce_style="color: #ff0000;" style="color: red;">netinet/if_ether.h</span>. The main fields in this structure that we need are&nbsp;<span id="" mce_style="color: #ff0000;" style="color: red;">ether_shosht&nbsp;</span>,&nbsp;<span id="" mce_style="color: #ff0000;" style="color: red;">ether_dhost</span>, these are used to extract the source and destination mac addresses. You need to declare &nbsp;a pointer of type struct ether_header, you can assign packet by simply assigning the type casted pointer which points to the packet as shown below.<br /><code>struct ether_header *eptr;<br />eptr = (struct ether_header *)packet; // packet is of type u_char *</code></div><div style="text-align: justify;">I had a lot of trouble in extracting the mac address from the packet and storing it in the form x:x:x:x:x:x . I found my own crude way of doing it and was succeeded in it also. I did as follows.<br /><code>i = ETHER_ADDR_LEN; // i = 6 bytes<br />ptr = ethernet_header-&gt;ether_shost;<br />do<br />{<br />sprintf(src_mac,"%s%x",(i == ETHER_ADDR_LEN)?" ":":",*ptr ++);<br />strcat(pktinfo-&gt;eth_src,src_mac);<br />}while(--i &gt; 0);</code></div><div style="text-align: justify;">The expression&nbsp;(i == ETHER_ADDR_LEN)?" ":":",*ptr ++) I got it from one of the references from&nbsp;<span id="" mce_style="color: #ff0000;" style="color: red;">tcpdump.org</span>. But they were simply printing the value on to screen and I want to store them into variable. I tried using sprintf to copy value into the variable directly from the expression. But each time the value was getting replaced by new value so what I did was to concatenate the value entered into the variable by sprintf into a new variable. After the loop finishes execution 2nd variable contains the mac address in the form x:x:x:x:x:x.</div><div style="text-align: justify;">Below is the code for the function I used to parse the ethernet header of the packet I captured.<br /><code><br />void Parse_Etherenet_Header(struct pkt_info *pktinfo,const struct pcap_pkthdr pkthdr,const u_char *packet)<br />{<br />char src_mac[50],dest_mac[50];<br />struct ether_header *ethernet_header;<br />int i;<br />u_char *ptr;</code></div><code></code><br /><code>src_mac[0] = dest_mac[0] = '\0';<br />/* Initialise the Time stamp */<br />strcpy(pktinfo -&gt; tm_stmp,(char *)ctime((const time_t*)&amp;pkthdr.ts.tv_sec));<br />pktinfo-&gt;tm_stmp[strlen(pktinfo-&gt;tm_stmp) - 1] = '\0';<br />ethernet_header = (struct ether_header *)packet;<br />/* Extract the Source Mac Address */<br />i = ETHER_ADDR_LEN; // i = 6 bytes<br />ptr = ethernet_header-&gt;ether_shost;<br />do<br />{<br />sprintf(src_mac,"%s%x",(i == ETHER_ADDR_LEN)?" ":":",*ptr ++);<br />strcat(pktinfo-&gt;eth_src,src_mac);<br />}while(--i &gt; 0);<br />/* Extract the Destination Mac Address */<br />i = ETHER_ADDR_LEN;<br />ptr = ethernet_header-&gt;ether_dhost;<br />do<br />{<br />sprintf(dest_mac,"%s%x",(i == ETHER_ADDR_LEN)?" ":":",*ptr ++);<br />strcat(pktinfo-&gt;eth_dest,dest_mac);<br />}while(--i &gt; 0);</code><br /><code>}</code><br /><div style="text-align: justify;">If you folks find out any mistake in the code above or if you have better way to implement the above function do comment. :)</div><div style="text-align: justify;">In my next post I'll discuss about parsing the rest of the packet that is IP, TCP/UDP portions.&nbsp;</div></div>
