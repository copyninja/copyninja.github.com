<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>Packet sniffer using pcap utility</title>
    <meta name="author" content="Vasudev Kamath" />

    <!-- Normalize CSS -->
    <link rel="stylesheet" href="/css/normalize.css" type="text/css"/>

    <!-- 1140 Grid CSS -->
    <link media="screen" rel="stylesheet" href="/css/1140.css" type="text/css"/>

    <!-- styles.css -->
    <link media="screen" rel="stylesheet" href="/css/styles.css" type="text/css"/>

    <!-- 1140 Grid CSS related javascript -->
    <script src="/js/css3-mediaqueries.js" type="text/javascript"></script>

    
    <!-- syntax highlighting CSS -->
    <link rel="stylesheet" href="/css/emacs.css" type="text/css" />

    <!-- Webfont url -->
    <link rel="stylesheet" href="/fonts/stylesheet-bitstream.css" type="text/css"/>
    <link rel="stylesheet" href="/fonts/stylesheet-angelina.css" type="text/css"/>
    <link rel="stylesheet" href="/fonts/stylesheet-aargh.css" type="text/css"/>
    <link rel="stylesheet" href="/fonts/stylesheet-lato.css" type="text/css"/>    

    <!-- Homepage CSS -->
    <link rel="stylesheet" href="/css/screen.css" type="text/css" media="screen, projection" />
  </head>
  <body>

    <div class="container header">
      <div class="row">
        <div class="site">
          <div class="title">
            <a href="/">Random Ramblings</a>
          </div>
          <div class="subheading">
            Random thoughts shooting out of volatile mind
          </div>
        </div>
      </div>
    </div>
    <div class="container details">
      <div class="row">
        <div class="eightcol">
          <div class="postheading">
  Packet sniffer using pcap utility
</div>
<div class="postbody">
  <div mce_style="text-align: justify" style="text-align: justify;">As a part of my project I needed to do a packet sniffer. Ifirst thought of using RAW SOCKETS for this purpose but later found that they have portability issue. Then I came accross pcap utility from tcpdump.org. Each distro has support for this utility. You need to get package libpcap-dev (i.e pcap development package). I did the coding in Debian Lenny so I needed to execute following command to get pcap library for my system.</div><blockquote>apt-get install libpcap*</blockquote><div mce_style="text-align: justify" style="text-align: justify;">To get the executable of your program you need to link it pcap library during the compilation which is done by providing -lpcap switch to the gcc or cc compiler.</div><blockquote>gcc -ggdb main.c -o sniffer -lpcap</blockquote><div mce_style="text-align: justify" style="text-align: justify;">-ggdb switch generates file containing debugging symbols used by gdb utility.</div><div mce_style="text-align: justify" style="text-align: justify;">Ok before jumping into coding part we need to know about few basic data structures and functions that we will use in the coding part. Let me start with a simple example.<img class="mceWPmore mceItemNoResize" mce_src="http://vasudevkamath.techfiz.com/wp-includes/js/tinymce/plugins/wordpress/img/trans.gif" src="http://vasudevkamath.techfiz.com/wp-includes/js/tinymce/plugins/wordpress/img/trans.gif" title="More..." /></div><pre name="code" class="c">#include &lt;pcap.h&gt;<br />int main(int argc,char **argv)<br />{<br />   pcap_t *handle;<br />   char *dev,errbuf[PCAP_ERRBUF_SIZE];<br />   u_char *packet;<br />   struct pcap_pkthdr hdr;<br />   dev = pcap_lookupdev(errbuf);<br />   if(dev == NULL){<br />     fprintf(stderr,"pcap_looupdev(): %s\n",errbuf);<br />     exit(1);<br />   }<br />   handle = pcap_open_live(dev,BUFSIZ,0,0,null);<br />   if(handle == NULL) {<br />     fprintf(stderr,"Failed to open %s\n",dev);<br />     exit(1);<br />   }<br />   while(1){<br />     packet = pcap_next(handle,&amp;hdr);<br />     /* ...<br />      * Process the captured packet here<br />      */<br />   }<br />}</pre><div mce_style="text-align: justify" style="text-align: justify;">Here the <b>pcap_t</b> is integer data type (similar) which holds the handle for the opened network interface. The structure <b>pcap_pkthdr</b> is defined as follows( man page of pcap.h)<br /><pre name="code" class="c">struct pcap_pkthdr {<br />   struct timeval ts; /* time stamp */<br />   bpf_u_int32 caplen; /* length of portion present */<br />   bpf_u_int32 len; /* length this packet (off wire) */<br />};</pre></div><div mce_style="text-align: justify" style="text-align: justify;">Well in my project I used only the time stamp field in this structure. Function <b>pcap_lookupdev</b> looks for the default interface of your system, so you don't have to worry about specifying interface to the program. If the function encounters error the error message is copied into the errbuf field. This function returs string i.e name of the interface in linux system default interface will be <b>eth0</b>.</div><div mce_style="text-align: justify" style="text-align: justify;">The function <b>pcap_open_live</b> opens the specified device for reading (capturing the packet) it returns handle to the device which will be used later to capture the packet from the interface. Prototype is as follows (pcap.h man page)</div><div mce_style="text-align: justify" style="text-align: justify;"><span class="Apple-style-span" mce_style="color: #000000;font-family: 'times new roman';font-size: 16px;font-style: normal;font-variant: normal;font-weight: normal" style="color: black; font-family: 'times new roman'; font-size: 16px; font-style: normal; font-variant: normal; font-weight: normal;"><br /><pre name="code" class="c">pcap_t *pcap_open_live(char *device, int snaplen, int promisc, int to_ms,char *ebuf)</pre></span></div><div mce_style="text-align: justify" style="text-align: justify;">Once this much is done you need to enter&nbsp; into infinite loop and use function <b>pcap_next </b>to capture packet. This function returns pointer to the captured packet, return type is u_char*. The prototype of function is as follows<br /><code> u_char *pcap_next(pcap_t *p, struct pcap_pkthdr *h)</code> </div><div mce_style="text-align: justify" style="text-align: justify;">Once you have captured the packet next is to extract information from it. I'll explain in my next post about the extraction of protocol related fields from the packet. Till then bye and have a nice day :)</div>

  <br/>
  <div class="meta_wrapper">
<ul class="tag_list_in_post">
    
    <li class="inline tag_list_item"><a class="tag_list_link" href="/tag/packet sniffer">packet sniffer</a></li>
    
    <li class="inline tag_list_item"><a class="tag_list_link" href="/tag/pcap utility">pcap utility</a></li>
    
</ul>
</div>
  
</div>
<div id="related">
  <h2>Related Posts</h2>
  <ul class="posts">
    
    <li><span>11 Mar 2012</span> &raquo; <a href="/2012/03/hello_planet%21.html">Hello Planet! (Debian)</a></li>
    
    <li><span>10 Mar 2012</span> &raquo; <a href="/2012/03/ttf-indic-fonts_to_fonts-indic_transition_complete%21.html">ttf-indic-fonts to fonts-indic transition complete!</a></li>
    
    <li><span>04 Mar 2012</span> &raquo; <a href="/2012/03/lato_fonts_for_debian.html">Lato Fonts for Debian</a></li>
    
  </ul>
</div>

<!-- Disqus -->
<div id="disqus_thread"></div>
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'randramblings'; // required: replace example with your forum shortname

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

        </div>
        <div class="fourcol last">
          <div class="main-menu">
            <div id="home-menu" class="main-menu-item "> <a href="/"> Home </a></div>
            <div id="me-menu" class="main-menu-item "><a href="/about"> About </a></div>
            <div id="project-menu" class="main-menu-item"> Projects and Talks </div>
            <div id="archive-menu" class="main-menu-item "> <a href="/archives"> Archives </a></div>
            <div id="package-menu" class="main-menu-item"> <a href="http://qa.debian.org/developer.php?login=kamathvasudev@gmail.com"> Debian Packages </a> </div>
          </div>
          <br/>
          <hr/>
          <br/>
          <div class="widget">
            Follow Me
            <br/>
            <br/>
            <a href="http://frndk.de/profile/copyninja"><image class="badge" src="/images/iamusingfriendika.png"/></a>
          </div>
          <br/>
          <hr/>
          <br/>
          <a href=><img src= "http://pics8.inxhost.com/images/sticker.gif" border="0" width="80" height="15"/></a>
          <a href="/rss"><img class="badge" width="73" height="18" longdesc="/rss" alt="XML: RSS Feed" src="/images/rssbutton.png"></a>
          <a href="/atom"><img class="badge" width="73" height="18" longdesc="/atom" alt="XML: Atom Feed" src="/images/atombutton.png"></a>
          <a href='https://www.ohloh.net/accounts/153053?ref=Tiny'>
            <img alt='Ohloh profile for copyninja' height='15' src='https://www.ohloh.net/accounts/153053/widgets/account_tiny.gif' width='80' />
          </a>
          <a href='http://www.catb.org/hacker-emblem/'>
            <img src='/images/hacker.png' alt='hacker emblem' />
          </a>
          <br/>
          <br/><a href="http://www.adfreeblog.org/" target="_blank"> <img src="http://www.adfreeblog.org/adfreebutton.jpg"></a>
          <br/>
          <a rel="license" href="http://creativecommons.org/licenses/by/3.0/">
            <img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by/3.0/88x31.png" />
          </a>
          <br/>
</a>          
</div>
</div>
</div>

<!-- Footer -->
<div class="container footer">
  <div class="site">
    <div class="row">
      <div class="footer">
        <div class="contact">
          <p>
            (c) 2012 Vasudeva Kamath<br />
            <br/>
            This blog is powered by <b> Jekyll </b> and <b>Emacs</b>
          </p>
        </div>
      </div>
    </div>
  </div>
</div>
<a href="http://github.com/copyninja"><img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" /></a>

</body>
</html>


