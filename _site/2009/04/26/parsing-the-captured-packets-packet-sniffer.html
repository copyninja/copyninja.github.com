<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>>Parsing the Captured Packets : Packet Sniffer</title>
    <meta name="author" content="Vasudev Kamath" />

    <!-- Normalize CSS -->
    <link rel="stylesheet" href="/blog/css/normalize.css" type="text/css"/>

    <!-- 1140 Grid CSS -->
    <link media="screen" rel="stylesheet" href="/blog/css/1140.css" type="text/css"/>

    <!-- styles.css -->
    <link media="screen" rel="stylesheet" href="/blog/css/styles.css" type="text/css"/>

    <!-- 1140 Grid CSS related javascript -->
    <script src="/blog/js/css3-mediaqueries.js" type="text/javascript"></script>

    
    <!-- syntax highlighting CSS -->
    <link rel="stylesheet" href="/blog/css/emacs.css" type="text/css" />

    <!-- Webfont url -->
    <link rel="stylesheet" href="/blog/fonts/stylesheet-bitstream.css" type="text/css"/>
    <link rel="stylesheet" href="/blog/fonts/stylesheet-angelina.css" type="text/css"/>

    <!-- Homepage CSS -->
    <link rel="stylesheet" href="/blog/css/screen.css" type="text/css" media="screen, projection" />

  </head>
  <body>

    <div class="container header">
      <div class="row">
        <div class="site">
          <div class="title">
            <a href="/">Random Ramblings</a>
          </div>
          <div class="subheading">
            Random thoughts shooting out of volatile mind
          </div>
        </div>
      </div>
    </div>
    <div class="container details">
      <div class="row">
        <div class="eightcol">
          <div id="post">
><div style="-webkit-background-clip: initial; -webkit-background-origin: initial; background-attachment: initial; background-color: white; background-image: initial; background-position: initial initial; background-repeat: initial; color: black; font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 10px; font: normal normal normal 13px/19px Georgia, 'Times New Roman', 'Bitstream Charter', Times, serif; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px; padding-bottom: 0.6em; padding-left: 0.6em; padding-right: 0.6em; padding-top: 0.6em;"><div style="text-align: justify;">In my&nbsp;<a href="http://vasudevkamath.techfiz.com/2009/03/30/packet-sniffer%E2%80%A6g-pcap-utility/" mce_href="http://vasudevkamath.techfiz.com/2009/03/30/packet-snifferâ€¦g-pcap-utility/" target="_blank">previous post</a>&nbsp;I had mentioned about how to use pcap utilities for capturing packets. Now in this post I'm going to tell about how to parse the packet and get information from it. Before I explain the code there are few basic data structure that you need to know.<br /><code>struct ether_header</code></div><div style="text-align: justify;">This structure is located in&nbsp;<span id="" mce_style="color: #ff0000;" style="color: red;">netinet/if_ether.h</span>. The main fields in this structure that we need are&nbsp;<span id="" mce_style="color: #ff0000;" style="color: red;">ether_shosht&nbsp;</span>,&nbsp;<span id="" mce_style="color: #ff0000;" style="color: red;">ether_dhost</span>, these are used to extract the source and destination mac addresses. You need to declare &nbsp;a pointer of type struct ether_header, you can assign packet by simply assigning the type casted pointer which points to the packet as shown below.<br /><code>struct ether_header *eptr;<br />eptr = (struct ether_header *)packet; // packet is of type u_char *</code></div><div style="text-align: justify;">I had a lot of trouble in extracting the mac address from the packet and storing it in the form x:x:x:x:x:x . I found my own crude way of doing it and was succeeded in it also. I did as follows.<br /><code>i = ETHER_ADDR_LEN; // i = 6 bytes<br />ptr = ethernet_header-&gt;ether_shost;<br />do<br />{<br />sprintf(src_mac,"%s%x",(i == ETHER_ADDR_LEN)?" ":":",*ptr ++);<br />strcat(pktinfo-&gt;eth_src,src_mac);<br />}while(--i &gt; 0);</code></div><div style="text-align: justify;">The expression&nbsp;(i == ETHER_ADDR_LEN)?" ":":",*ptr ++) I got it from one of the references from&nbsp;<span id="" mce_style="color: #ff0000;" style="color: red;">tcpdump.org</span>. But they were simply printing the value on to screen and I want to store them into variable. I tried using sprintf to copy value into the variable directly from the expression. But each time the value was getting replaced by new value so what I did was to concatenate the value entered into the variable by sprintf into a new variable. After the loop finishes execution 2nd variable contains the mac address in the form x:x:x:x:x:x.</div><div style="text-align: justify;">Below is the code for the function I used to parse the ethernet header of the packet I captured.<br /><code><br />void Parse_Etherenet_Header(struct pkt_info *pktinfo,const struct pcap_pkthdr pkthdr,const u_char *packet)<br />{<br />char src_mac[50],dest_mac[50];<br />struct ether_header *ethernet_header;<br />int i;<br />u_char *ptr;</code></div><code></code><br /><code>src_mac[0] = dest_mac[0] = '\0';<br />/* Initialise the Time stamp */<br />strcpy(pktinfo -&gt; tm_stmp,(char *)ctime((const time_t*)&amp;pkthdr.ts.tv_sec));<br />pktinfo-&gt;tm_stmp[strlen(pktinfo-&gt;tm_stmp) - 1] = '\0';<br />ethernet_header = (struct ether_header *)packet;<br />/* Extract the Source Mac Address */<br />i = ETHER_ADDR_LEN; // i = 6 bytes<br />ptr = ethernet_header-&gt;ether_shost;<br />do<br />{<br />sprintf(src_mac,"%s%x",(i == ETHER_ADDR_LEN)?" ":":",*ptr ++);<br />strcat(pktinfo-&gt;eth_src,src_mac);<br />}while(--i &gt; 0);<br />/* Extract the Destination Mac Address */<br />i = ETHER_ADDR_LEN;<br />ptr = ethernet_header-&gt;ether_dhost;<br />do<br />{<br />sprintf(dest_mac,"%s%x",(i == ETHER_ADDR_LEN)?" ":":",*ptr ++);<br />strcat(pktinfo-&gt;eth_dest,dest_mac);<br />}while(--i &gt; 0);</code><br /><code>}</code><br /><div style="text-align: justify;">If you folks find out any mistake in the code above or if you have better way to implement the above function do comment. :)</div><div style="text-align: justify;">In my next post I'll discuss about parsing the rest of the packet that is IP, TCP/UDP portions.&nbsp;</div></div>

</div>

<div id="related">
  <h2>Related Posts</h2>
  <ul class="posts">
    
      <li><span>23 Dec 2011</span> &raquo; <a href=" / /2011/12/23/dh-make-font-a-font-package-helper-for-debian.html">>dh-make-font - A Font package helper for Debian</a></li>
    
      <li><span>14 Dec 2011</span> &raquo; <a href=" / /2011/12/14/my-journey-with-debian-and-floss-part-2.html">>My Journey with Debian and FLOSS - Part 2</a></li>
    
      <li><span>13 Dec 2011</span> &raquo; <a href=" / /2011/12/13/my-journey-with-debian-and-floss-part-1.html">>My Journey with Debian and FLOSS - Part 1</a></li>
    
  </ul>
</div>

        </div>
        <div class="fourcol last">
          <div class="widget">
            Connect to me on Friendica
            <script src="http://frndk.de/widgets/friends?k=37533857"></script>
          </div>
        </div>
      </div>
    </div>

    <div class="container footer">
      <div class="site">
        <div class="row">
          <div class="footer">
            <div class="contact">
              <p>
                (c) 2012 Vasudeva Kamath<br />
                The contents of this site are shared under <a href="http://creativecommons.org/licenses/by-sa/3.0/" class="contact">CC-BY-SA-3.0 Unported</a>
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
    <a href="http://github.com/copyninja"><img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" /></a>
  </body>
</html>


